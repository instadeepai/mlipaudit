from pathlib import Path

import pytest
from unittest.mock import patch
from mlip.simulation import SimulationState


# Import the base class as well to help with mocking
from mlipaudit.small_molecule_geometrics.ring_planarity import RingPlanarityBenchmark, RingPlanarityModelOutput, \
    MoleculeSimulationOutput
import numpy as np

INPUT_DATA_DIR = Path(__file__).parent.parent / "data"



@pytest.fixture
def ring_planarity_benchmark(
    request,
    mocked_benchmark_init,  # Use the generic init mock
    mock_force_field,  # Use the generic force field mock
) -> RingPlanarityBenchmark:
    """Assembles a fully configured and isolated RingPlanarityBenchmark instance.

    This fixture is parameterized to handle the `fast_dev_run` flag.

    Returns:
        An initialized RingPlanarityBenchmark instance.
    """
    is_fast_run = getattr(request, "param", False)

    return RingPlanarityBenchmark(
        force_field=mock_force_field,
        data_input_dir=INPUT_DATA_DIR,
        fast_dev_run=is_fast_run,
    )


@pytest.mark.parametrize("ring_planarity_benchmark", [True], indirect=True)
def test_run(ring_planarity_benchmark, mock_jaxmd_simulation_engine):
    benchmark = ring_planarity_benchmark
    mock_engine = mock_jaxmd_simulation_engine()
    with patch(
        "mlipaudit.small_molecule_geometrics.ring_planarity.JaxMDSimulationEngine",
        return_value=mock_engine,
    ) as mock_engine_class:
        benchmark.run_model()

        # Assert that the engine was initialized and run for each molecule
        num_molecules = len(benchmark._qm9_structures)
        assert mock_engine_class.call_count == num_molecules
        assert mock_engine.run.call_count == num_molecules

        assert isinstance(benchmark.model_output, RingPlanarityModelOutput)

        benchmark.model_output = RingPlanarityModelOutput(
            molecule_simulations=[
                MoleculeSimulationOutput(
                    molecule_name="benzene",
                    simulation_state=SimulationState(
                        positions=np.array([[[0.4726062978876191, 0.014562810679250138, 0.9002570248372566], [0.19320256520236956, 0.15499448814405437, 0.8686839380377862], [0.31653031345485094, 0.3205340714455577, 0.5216235734808454], [0.14804359103508113, 0.10260874025098454, 0.6837427068863838], [0.3089845266307891, 0.9536675840643054, 0.8502202643817952], [0.6156127911634268, 0.37976164355953856, 0.9602928119514782], [0.7068270801845161, 0.2167298448840821, 0.7808384289616612], [0.22624401001667382, 0.020978244522960043, 0.781059833440326], [0.8042395037226986, 0.5780249379911583, 0.8339534188693563], [0.20233191726598343, 0.6423574364047678, 0.12955580683037715], [0.594333866016802, 0.5746203605863349, 0.026459470361010706], [0.8257683835076594, 0.4908229536387352, 0.558294555300685]], [[0.751269446427742, 0.8169183531853014, 0.938584840817844], [0.7635748073781164, 0.40665881821230276, 0.14738690088982553], [0.9873653726166213, 0.628561354759795, 0.16533039250148207], [0.18754810759772012, 0.5283188577683879, 0.11405701395435341], [0.4129257341489344, 0.5291148236241603, 0.5496742347700209], [0.5044461265217598, 0.38665000480247413, 0.5971618953661286], [0.8119309462498564, 0.5861641481064098, 0.9940048609432286], [0.5092656859184739, 0.14282943326904207, 0.08142185185351736], [0.25475078812645136, 0.8773604737262566, 0.9254854760909851], [0.865275264232785, 0.9935939171970661, 0.4408847860268833], [0.46829640469334266, 0.363863775545614, 0.7787039411770864], [0.34569248645103856, 0.019309454921375147, 0.2952179622079142]], [[0.6214020805177553, 0.24368113232390076, 0.6274273040370574], [0.802759818037684, 0.11542784655473814, 0.8878960134620439], [0.284432360841387, 0.07805695531816759, 0.14991138370817614], [0.8485519839939852, 0.24988143383738537, 0.13472874438844273], [0.6829297584533384, 0.8625753766810124, 0.8404050551373733], [0.7006641547930931, 0.3440767223694875, 0.4241396502715967], [0.5810836933085993, 0.5530794967254754, 0.6855188429896981], [0.9592805907990104, 0.7740849854674829, 0.9589702921433366], [0.42242683993984853, 0.019196880021264184, 0.06267835527533794], [0.7067620047996419, 0.2951628974565468, 0.5214560241472583], [0.10798060465698822, 0.21415720286462336, 0.3776738794358452], [0.5545179101955154, 0.017623582547305894, 0.15076861214233583]], [[0.7848438875406685, 0.5575412501224671, 0.7486811657852377], [0.12205401701855911, 0.5500276956963978, 0.3304803399813384], [0.5491628603159263, 0.7651604797617498, 0.9011607751482538], [0.6491461564228159, 0.8238535808398318, 0.020824141665610196], [0.21763397052154898, 0.6150461327445416, 0.33137204028263245], [0.9512862743469707, 0.7610922431452076, 0.2967496958343999], [0.9338980996758118, 0.8996603742428081, 0.042926427502090414], [0.3701494049330316, 0.21177576972296086, 0.3367849639282118], [0.2643352562245487, 0.07417916138768255, 0.7107769397029398], [0.06873639746837423, 0.4469033675176064, 0.38794181335515976], [0.18052651651906915, 0.4891292299053085, 0.7034344299419514], [0.6180111984775003, 0.3448229656240086, 0.8525223879409832]], [[0.48817749239653774, 0.7360504727983418, 0.771610965794675], [0.09979848884216391, 0.36253799711371226, 0.277692094359259], [0.34750954272242274, 0.14566451294745963, 0.22647590162734854], [0.6089697238702263, 0.22423214612103526, 0.32503300429089843], [0.9664738087785277, 0.9197074161809915, 0.01458103689558754], [0.634415189229316, 0.8051471956149575, 0.4889239210138], [0.36177441512540265, 0.48254595431737113, 0.7811452952827247], [0.25489802724065236, 0.30236927492670385, 0.9884435173315497], [0.5708003182460066, 0.6740697900170517, 0.8768485006156149], [0.12109343610705903, 0.05274667013325951, 0.20385760866026537], [0.8117778181216899, 0.060251716006635814, 0.31725524195637056], [0.04187290613238581, 0.4410828414827398, 0.3818223441877794]], [[0.05796252747585462, 0.07717953434199298, 0.17134614595202113], [0.30194077399347163, 0.45155354254981994, 0.09892193416130157], [0.8005965150221444, 0.8232579689065957, 0.29745006335751245], [0.9028147716792964, 0.32595020251441464, 0.9301148783490545], [0.08835296482837585, 0.5989463409356287, 0.387350487884768], [0.30450694224327046, 0.06667011470601814, 0.6326407032548097], [0.8083541740149418, 0.5967694311275608, 0.5748766134440892], [0.9403224062107428, 0.6998473470925987, 0.8978094605771918], [0.8266438741977067, 0.02406483387648828, 0.1379225632300406], [0.039625317117125025, 0.8770760467401991, 0.17559136919762686], [0.32395290577112856, 0.7805408907508921, 0.7239301138627405], [0.231769502686472, 0.6058003073518985, 0.9044994868328605]], [[0.08078662418841454, 0.24677723536419083, 0.41907463527874667], [0.31549520414837096, 0.36270460691659023, 0.35169014413115995], [0.3656758182415719, 0.4408843971492189, 0.0455987587630855], [0.8705992810188823, 0.34044597146291766, 0.4877605279265662], [0.8347378931387734, 0.8315524711838903, 0.4907497893663326], [0.3191086985373872, 0.06438328091122048, 0.7966315426064838], [0.44975346575295605, 0.24454839866342637, 0.043968552743463674], [0.7012462942850524, 0.6060630230865266, 0.9747314963578597], [0.012382548727861487, 0.9283112531961827, 0.33952803976852775], [0.5725629656707485, 0.6725934623243391, 0.6697725245815683], [0.5509059856778362, 0.4071362861871921, 0.3638562129155295], [0.09995643472873805, 0.1623374804371206, 0.351855633470866]], [[0.2244972978550258, 0.29708266113712745, 0.6590970663931829], [0.22146344343084123, 0.8470490036337163, 0.2241731443158671], [0.9411137158779656, 0.6482819626630872, 0.7989772700716758], [0.20378608760175587, 0.6577295601069945, 0.45786896704117275], [0.06972129335788246, 0.050710702402055885, 0.05073323202574931], [0.4219166305137326, 0.9431877519100416, 0.4458336456017702], [0.9460862271457787, 0.17519809534889141, 0.6250832372136824], [0.8514163875774495, 0.32347162309142374, 0.6534195651821548], [0.9080114494211489, 0.6470439764733801, 0.9615225919999427], [0.0374868679526672, 0.5712316036421266, 0.45402447623696207], [0.9484309838731853, 0.3387987286758679, 0.1701491954217894], [0.9031152895913704, 0.3338630837546358, 0.5711911960421018]], [[0.9222195272870385, 0.39823213061329754, 0.7574765639747308], [0.28678414806787955, 0.9571410964644377, 0.8702402678982307], [0.2252517345794396, 0.9353205966813481, 0.8742638567763197], [0.9148787610421216, 0.05227562486548243, 0.8165149276489706], [0.1605819094940013, 0.39103691263170803, 0.5059730687254721], [0.12351724312200862, 0.1464703252459698, 0.3655486513993551], [0.7855597864788708, 0.3261268854128948, 0.5291617773427538], [0.1931030635884492, 0.24458197197550513, 0.8355988611035093], [0.6916104122326201, 0.7906747204690415, 0.8613856444345197], [0.5006107328583063, 0.2990891308536796, 0.9717616445585163], [0.7467885643755973, 0.06177206092530041, 0.6288283019826034], [0.7967362642688482, 0.86093698086183, 0.918151668789046]], [[0.4263905420352413, 0.5622442760031637, 0.7698924234165241], [0.32199716562286496, 0.9127256136194322, 0.8134851595329582], [0.7349611494947861, 0.463557729829572, 0.9991025138025674], [0.0008340448392728517, 0.25271076018151417, 0.6375553680611165], [0.18085146504822824, 0.01733900533306232, 0.4873234851930225], [0.4245343585539034, 0.6231129794997532, 0.3310283315023512], [0.6352781776141629, 0.03729108046327545, 0.4558952401541946], [0.29136755823009275, 0.16287527934473134, 0.03180754557115206], [0.6400868508680801, 0.09996732697139554, 0.2619256754376925], [0.4226381490288561, 0.568598019312094, 0.2060224164203952], [0.837479079576843, 0.8329659704626727, 0.4976815348797532], [0.81114798005023, 0.6395643485480688, 0.12905854578755094]]])
                    )
                ),
                MoleculeSimulationOutput(
                    molecule_name="furan",
                    simulation_state=SimulationState(
                        positions=np.array([[[0.8799587244448055, 0.6096066611042985, 0.8468927409696325], [0.3081718975065123, 0.09179706828186007, 0.3359340547143945], [0.5423497838544701, 0.20098239962631925, 0.12457558854581874], [0.6762917843096431, 0.5145985072137391, 0.017602448047940422], [0.20413253955591115, 0.957733284293183, 0.334733573256501], [0.16420700182246128, 0.09238074440991395, 0.3718597435799139], [0.8459434705435359, 0.5790200662492133, 0.7767654150896159], [0.6062340122408623, 0.39599119026992224, 0.31527830775282895], [0.9122469512319156, 0.6407479675638518, 0.7842184718511871]], [[0.512929372455875, 0.9166357813085434, 0.9269343612600663], [0.9477147093877781, 0.4289086252753329, 0.8529761531905967], [0.4811054173951119, 0.34174330358057015, 0.3341221089302969], [0.7967707988995747, 0.2766624333690203, 0.4047762382662675], [0.6415919564017274, 0.18503438470510292, 0.12032101537570827], [0.29254115725886143, 0.9531634725072042, 0.3231904749661555], [0.3415080445617138, 0.4999757475408819, 0.920539803248334], [0.12240437331123699, 0.6393157629333653, 0.4295834079574671], [0.31467430423874065, 0.5327378538472299, 0.513533549330559]], [[0.6761176777208326, 0.8492790308183533, 0.5057113481853803], [0.7736238199349746, 0.5933300658794195, 0.14694675508824062], [0.810074851408627, 0.056719859191527555, 0.2748261054390264], [0.3990879791052099, 0.5416263861013116, 0.08983366027113737], [0.9524708389944214, 0.8224034780655064, 0.5752422502946439], [0.7238454035859281, 0.9622623634136462, 0.4544152856371283], [0.79558596771489, 0.9374600753258022, 0.7054927232469327], [0.3860217260715658, 0.8468507910746965, 0.7689399809292344], [0.7329260308887994, 0.552965249609691, 0.7668412051731561]], [[0.999197351870651, 0.32714011737119975, 0.9372421825531098], [0.10313159889024548, 0.39593017627886073, 0.7734397881172592], [0.674830761941239, 0.30214895421087784, 0.49240705638095494], [0.10956000906196561, 0.053125866202642924, 0.8013130581589929], [0.9567494737536827, 0.5224219186396977, 0.8589929806573583], [0.7841253410223271, 0.9366577909775797, 0.6858327672634954], [0.7832294807312613, 0.4445986022836491, 0.6958126804977991], [0.12205762953967803, 0.07620545250117094, 0.21867880715690557], [0.3528104897450929, 0.8941079232359215, 0.3238802578103622]], [[0.05915979108204028, 0.5259439330474525, 0.1308180392820686], [0.8187344687562521, 0.12834290257369796, 0.26600590404831015], [0.24196528660381755, 0.19841967533370564, 0.5332507137267636], [0.6029801638002649, 0.31149452032807157, 0.2968844715599752], [0.527669660088334, 0.4931322125484747, 0.9478720982849668], [0.04371404676389634, 0.0952111251255583, 0.720511209388453], [0.7114107930340402, 0.17781561023371595, 0.5244715330996468], [0.07709352423161842, 0.4724061815593412, 0.7475244435653903], [0.3849877946080572, 0.16029629368917542, 0.10029756719532046]], [[0.08940464512530888, 0.1477596496135527, 0.16724489047848312], [0.41764519439762315, 0.5462214109504226, 0.3854169145440016], [0.48120288219957164, 0.48616737600092985, 0.11902630322887886], [0.0017496350499545121, 0.5148195807650018, 0.2425088081429172], [0.07251354776556684, 0.062263607488042716, 0.7648661154704062], [0.2252822779190775, 0.5092341501580537, 0.5510980128485562], [0.40745306249280466, 0.1628983442448162, 0.8100124061172023], [0.8774306487398118, 0.4455721455125172, 0.32336608293618696], [0.3376310396333163, 0.382208952684427, 0.13846481379914877]], [[0.46861670743587625, 0.9587776216200091, 0.46995487872703146], [0.06143120828604076, 0.41891668346480193, 0.5617661659532142], [0.6709499417414136, 0.42527476258883457, 0.6316263641475982], [0.0314207893812144, 0.8690157307601393, 0.5589671315977688], [0.3106357070037291, 0.9041819587116544, 0.03867898404960224], [0.5438477343459908, 0.6867194994066121, 0.938450266810654], [0.6339923696826177, 0.1754261679231791, 0.9546952103594105], [0.6105512823183312, 0.4660187122717666, 0.805394803641513], [0.9288518324897045, 0.4999204277343553, 0.8183101147649315]], [[0.20347149197191305, 0.056955118654123504, 0.1877746398993373], [0.8642642126398797, 0.5808639356259958, 0.4083821225877916], [0.3205493068263746, 0.18409601977986967, 0.9248195598431317], [0.3568861392667524, 0.6318995582007199, 0.4063118095680003], [0.051871056948473715, 0.1529020613612988, 0.09798577916071971], [0.8778432481053288, 0.9903629762233231, 0.8439171628813821], [0.4096670018562305, 0.4836050463597733, 0.5556362571223634], [0.62557197947891, 0.19556343780059338, 0.9271648989695153], [0.23288942691506376, 0.9955107544793468, 0.5361294820199597]], [[0.4155559181593842, 0.985037169301261, 0.7042286009437808], [0.5451584864794029, 0.1729876443645888, 0.7944254968898024], [0.35681490215641587, 0.9894927976853148, 0.21780998558296238], [0.3994578988513352, 0.3174273862455883, 0.29218703159391657], [0.11966355602243994, 0.35558170916695775, 0.5717456585371232], [0.3258076322997404, 0.7239639320427578, 0.8373866562785478], [0.6477185373423447, 0.3020554380350101, 0.639229789506764], [0.9057052830511596, 0.8356847757061864, 0.33364378051727617], [0.49562625272740746, 0.9761807216247433, 0.5108302651072205]], [[0.9671498373306444, 0.420881752758687, 0.7629954193635196], [0.02514244232298668, 0.793731629555041, 0.2761272115131571], [0.07720861896319553, 0.5899437709394568, 0.16843450247821568], [0.3943621397997783, 0.6572614187880726, 0.2704002816283768], [0.7883347897020814, 0.8734466345027302, 0.5437969975938897], [0.1509717667166669, 0.20609057531287522, 0.4781938744865749], [0.5308229937076826, 0.7781694389538897, 0.09779703676461138], [0.9495503041839417, 0.603847596865166, 0.2589466522582782], [0.49625082650906494, 0.3468376166634761, 0.08233974993444615]]])
                    )
                )
            ],
        )

        results = benchmark.analyze()
        assert len(results.molecule_results) == num_molecules